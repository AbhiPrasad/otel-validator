---
export const prerender = false;
import Layout from '../components/Layout.astro';
---

<Layout 
  title="Collector Config Validator" 
  description="Validate OpenTelemetry Collector YAML configurations"
  activeNav="collector-config"
>
  <h1>Collector Config Validator</h1>
  <p class="subtitle">Validate OpenTelemetry Collector YAML configurations and identify issues</p>
  
  <!-- Validate Section -->
  <div class="card">
    <h2>Configuration</h2>
    
    <div class="editor-toolbar">
      <button class="secondary-btn" id="sample-btn">Load Sample</button>
      <button class="secondary-btn" id="clear-btn">Clear</button>
    </div>
    
    <textarea 
      id="config-input" 
      placeholder="Paste your OTel Collector YAML configuration here..."
      spellcheck="false"
    ></textarea>
    
    <div class="buttons">
      <button class="primary-btn" id="validate-btn">Validate Configuration</button>
    </div>
  </div>
  
  <!-- Results Section -->
  <div class="card" id="results-section" style="display: none;">
    <h2>Validation Results</h2>
    <div id="results-container"></div>
  </div>
  
  <!-- Known Components Reference -->
  <div class="card">
    <h2>Known Components</h2>
    <p class="section-description">Common OpenTelemetry Collector components. Custom components may show warnings.</p>
    
    <div class="component-tabs">
      <button class="tab-btn active" data-tab="receivers">Receivers</button>
      <button class="tab-btn" data-tab="processors">Processors</button>
      <button class="tab-btn" data-tab="exporters">Exporters</button>
      <button class="tab-btn" data-tab="extensions">Extensions</button>
    </div>
    
    <div id="components-list" class="components-list"></div>
  </div>
</Layout>

<style>
  .section-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0 0 1rem 0;
  }
  
  .editor-toolbar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }
  
  textarea {
    height: 400px;
    font-family: "Monaco", "Menlo", "Consolas", monospace;
    font-size: 13px;
    line-height: 1.5;
  }
  
  .buttons {
    margin-top: 1rem;
  }
  
  .result-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  
  .result-summary.valid {
    background: var(--success-bg);
    border: 1px solid var(--success-border);
    color: var(--success);
  }
  
  .result-summary.invalid {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
    color: var(--error);
  }
  
  .result-summary .icon {
    font-size: 1.5rem;
  }
  
  .result-summary .text {
    font-weight: 600;
  }
  
  .result-counts {
    display: flex;
    gap: 1rem;
    margin-left: auto;
  }
  
  .result-count {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .result-count.errors {
    background: var(--error);
    color: white;
  }
  
  .result-count.warnings {
    background: var(--warning);
    color: white;
  }
  
  .issues-section {
    margin-top: 1rem;
  }
  
  .issues-section h3 {
    font-size: 1rem;
    margin: 0 0 0.75rem 0;
    color: var(--text-secondary);
  }
  
  .issue-item {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
  }
  
  .issue-item.error {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
  }
  
  .issue-item.warning {
    background: var(--warning-bg);
    border: 1px solid var(--warning-border);
  }
  
  .issue-icon {
    font-size: 1rem;
    flex-shrink: 0;
  }
  
  .issue-content {
    flex: 1;
  }
  
  .issue-path {
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
  }
  
  .issue-message {
    color: var(--text-primary);
  }
  
  .issue-suggestion {
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-style: italic;
  }
  
  .component-tabs {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .tab-btn {
    padding: 0.5rem 1rem;
    border: none;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .tab-btn:hover {
    background: var(--button-secondary-hover);
  }
  
  .tab-btn.active {
    background: var(--accent-primary);
    color: white;
  }
  
  .components-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .component-tag {
    padding: 0.25rem 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 20px;
    font-size: 0.85rem;
    font-family: monospace;
    color: var(--text-secondary);
  }
  
  @media (max-width: 640px) {
    .result-summary {
      flex-wrap: wrap;
    }
    
    .result-counts {
      margin-left: 0;
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>

<script>
  import { parseYAML, validateConfig, getKnownComponents, getSampleConfig } from '../lib/collector-config';
  
  // DOM Elements
  const configInput = document.getElementById('config-input') as HTMLTextAreaElement;
  const validateBtn = document.getElementById('validate-btn') as HTMLButtonElement;
  const sampleBtn = document.getElementById('sample-btn') as HTMLButtonElement;
  const clearBtn = document.getElementById('clear-btn') as HTMLButtonElement;
  const resultsSection = document.getElementById('results-section') as HTMLDivElement;
  const resultsContainer = document.getElementById('results-container') as HTMLDivElement;
  const componentsList = document.getElementById('components-list') as HTMLDivElement;
  
  // Load known components
  const knownComponents = getKnownComponents();
  let currentTab = 'receivers';
  
  function renderComponents(tab: string) {
    const components = knownComponents[tab as keyof typeof knownComponents] || [];
    componentsList.innerHTML = components
      .map(c => `<span class="component-tag">${c}</span>`)
      .join('');
  }
  
  // Initialize with receivers
  renderComponents('receivers');
  
  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab') || 'receivers';
      currentTab = tab;
      renderComponents(tab);
    });
  });
  
  // Sample button
  sampleBtn.onclick = () => {
    configInput.value = getSampleConfig();
  };
  
  // Clear button
  clearBtn.onclick = () => {
    configInput.value = '';
    resultsSection.style.display = 'none';
  };
  
  // Validate button
  validateBtn.onclick = () => {
    const yaml = configInput.value.trim();
    
    if (!yaml) {
      resultsSection.style.display = 'block';
      resultsContainer.innerHTML = `
        <div class="result-summary invalid">
          <span class="icon">âœ—</span>
          <span class="text">Please enter a configuration</span>
        </div>
      `;
      return;
    }
    
    // Parse YAML first
    const parseResult = parseYAML(yaml);
    
    if (!parseResult.success) {
      resultsSection.style.display = 'block';
      resultsContainer.innerHTML = `
        <div class="result-summary invalid">
          <span class="icon">âœ—</span>
          <span class="text">YAML Parse Error</span>
        </div>
        <div class="issues-section">
          <div class="issue-item error">
            <span class="issue-icon">âœ—</span>
            <div class="issue-content">
              <div class="issue-message">${escapeHtml(parseResult.error || 'Unknown parse error')}</div>
              ${parseResult.line ? `<div class="issue-path">Line ${parseResult.line}</div>` : ''}
            </div>
          </div>
        </div>
      `;
      return;
    }
    
    // Validate the parsed config
    const result = validateConfig(parseResult.data);
    
    resultsSection.style.display = 'block';
    
    let html = '';
    
    // Summary
    if (result.valid) {
      html += `
        <div class="result-summary valid">
          <span class="icon">âœ“</span>
          <span class="text">Configuration is valid</span>
          ${result.warnings.length > 0 ? `
            <div class="result-counts">
              <span class="result-count warnings">${result.warnings.length} warning${result.warnings.length !== 1 ? 's' : ''}</span>
            </div>
          ` : ''}
        </div>
      `;
    } else {
      html += `
        <div class="result-summary invalid">
          <span class="icon">âœ—</span>
          <span class="text">Configuration has issues</span>
          <div class="result-counts">
            ${result.errors.length > 0 ? `<span class="result-count errors">${result.errors.length} error${result.errors.length !== 1 ? 's' : ''}</span>` : ''}
            ${result.warnings.length > 0 ? `<span class="result-count warnings">${result.warnings.length} warning${result.warnings.length !== 1 ? 's' : ''}</span>` : ''}
          </div>
        </div>
      `;
    }
    
    // Errors
    if (result.errors.length > 0) {
      html += `
        <div class="issues-section">
          <h3>Errors</h3>
          ${result.errors.map(e => `
            <div class="issue-item error">
              <span class="issue-icon">âœ—</span>
              <div class="issue-content">
                <div class="issue-path">${escapeHtml(e.path)}</div>
                <div class="issue-message">${escapeHtml(e.message)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // Warnings
    if (result.warnings.length > 0) {
      html += `
        <div class="issues-section">
          <h3>Warnings</h3>
          ${result.warnings.map(w => `
            <div class="issue-item warning">
              <span class="issue-icon">âš </span>
              <div class="issue-content">
                <div class="issue-path">${escapeHtml(w.path)}</div>
                <div class="issue-message">${escapeHtml(w.message)}</div>
                ${w.suggestion ? `<div class="issue-suggestion">ðŸ’¡ ${escapeHtml(w.suggestion)}</div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    resultsContainer.innerHTML = html;
  };
  
  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
</script>
