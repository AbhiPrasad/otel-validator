---
export const prerender = false;
import Layout from '../components/Layout.astro';
---

<Layout 
  title="Trace Context" 
  description="Encode and decode W3C traceparent and tracestate headers"
  activeNav="trace-context"
>
  <h1>W3C Trace Context</h1>
  <p class="subtitle">Encode and decode traceparent and tracestate headers for distributed tracing</p>
  
  <!-- Decode Section -->
  <div class="card">
    <h2>Decode traceparent</h2>
    <p class="section-description">Parse a traceparent header to extract its components</p>
    
    <div class="input-group">
      <input 
        type="text" 
        id="decode-input" 
        placeholder="00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01"
        spellcheck="false"
        autocomplete="off"
      />
      <button class="secondary-btn" id="decode-btn">Decode</button>
      <button class="secondary-btn" id="sample-btn">Sample</button>
    </div>
    
    <div id="decode-results" class="results-area"></div>
  </div>
  
  <!-- Encode Section -->
  <div class="card">
    <h2>Encode traceparent</h2>
    <p class="section-description">Build a traceparent header from components</p>
    
    <div class="encode-form">
      <div class="form-row">
        <div class="form-group">
          <label for="encode-version">Version</label>
          <input type="text" id="encode-version" value="00" maxlength="2" />
        </div>
        <div class="form-group wide">
          <label for="encode-trace-id">Trace ID (32 hex chars)</label>
          <input type="text" id="encode-trace-id" placeholder="0af7651916cd43dd8448eb211c80319c" maxlength="32" />
          <button class="icon-btn" id="gen-trace-id" title="Generate random">↻</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group wide">
          <label for="encode-span-id">Span ID (16 hex chars)</label>
          <input type="text" id="encode-span-id" placeholder="b7ad6b7169203331" maxlength="16" />
          <button class="icon-btn" id="gen-span-id" title="Generate random">↻</button>
        </div>
        <div class="form-group">
          <label for="encode-sampled">Flags</label>
          <label class="checkbox-label">
            <input type="checkbox" id="encode-sampled" checked />
            Sampled
          </label>
        </div>
      </div>
      <button class="primary-btn" id="encode-btn">Generate traceparent</button>
    </div>
    
    <div id="encode-results" class="results-area"></div>
  </div>
  
  <!-- Tracestate Section -->
  <div class="card">
    <h2>Parse tracestate</h2>
    <p class="section-description">Parse vendor-specific trace state key-value pairs</p>
    
    <div class="input-group">
      <input 
        type="text" 
        id="tracestate-input" 
        placeholder="vendor1=value1,vendor2=value2"
        spellcheck="false"
        autocomplete="off"
      />
      <button class="secondary-btn" id="tracestate-btn">Parse</button>
    </div>
    
    <div id="tracestate-results" class="results-area"></div>
  </div>
  
  <!-- Info Section -->
  <div class="card info-card">
    <h2>About W3C Trace Context</h2>
    <dl>
      <dt>traceparent</dt>
      <dd>A header containing version, trace-id, parent-id (span-id), and trace-flags. Format: <code>version-traceid-parentid-flags</code></dd>
      
      <dt>tracestate</dt>
      <dd>A header containing vendor-specific trace context as comma-separated key=value pairs.</dd>
      
      <dt>Specification</dt>
      <dd><a href="https://www.w3.org/TR/trace-context/" target="_blank" rel="noopener noreferrer">W3C Trace Context</a></dd>
    </dl>
  </div>
</Layout>

<style>
  .section-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0 0 1rem 0;
  }
  
  .input-group {
    display: flex;
    gap: 0.5rem;
  }
  
  .input-group input {
    flex: 1;
    font-family: monospace;
  }
  
  .results-area {
    margin-top: 1rem;
    min-height: 20px;
  }
  
  .encode-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .form-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    position: relative;
  }
  
  .form-group.wide {
    flex: 1;
    min-width: 200px;
  }
  
  .form-group label {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }
  
  .form-group input[type="text"] {
    font-family: monospace;
    padding-right: 2.5rem;
  }
  
  .form-group input[maxlength="2"] {
    width: 60px;
  }
  
  .icon-btn {
    position: absolute;
    right: 4px;
    bottom: 4px;
    width: 28px;
    height: 28px;
    padding: 0;
    border: none;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .icon-btn:hover {
    background: var(--accent-primary);
    color: white;
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem 0;
  }
  
  .checkbox-label input {
    accent-color: var(--accent-primary);
    width: 18px;
    height: 18px;
  }
  
  .result-box {
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 1rem;
    font-family: monospace;
    word-break: break-all;
  }
  
  .result-box.success {
    background: var(--success-bg);
    border: 1px solid var(--success-border);
  }
  
  .result-box.error {
    background: var(--error-bg);
    border: 1px solid var(--error-border);
  }
  
  .result-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
    margin-top: 0.75rem;
  }
  
  .result-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-family: sans-serif;
  }
  
  .result-value {
    color: var(--text-primary);
    word-break: break-all;
  }
  
  .result-value.highlight {
    color: var(--accent-primary);
  }
  
  .copy-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
  }
  
  .copy-row code {
    flex: 1;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 0.9rem;
    word-break: break-all;
  }
  
  .tracestate-table {
    width: 100%;
    margin-top: 0.75rem;
    border-collapse: collapse;
  }
  
  .tracestate-table th,
  .tracestate-table td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }
  
  .tracestate-table th {
    color: var(--text-secondary);
    font-weight: 600;
  }
  
  .tracestate-table td {
    font-family: monospace;
  }
  
  .info-card {
    background: var(--bg-tertiary);
  }
  
  .info-card h2 {
    color: var(--text-primary);
  }
  
  .info-card dl {
    margin: 0;
  }
  
  .info-card dt {
    font-weight: 600;
    color: var(--accent-primary);
    margin-top: 1rem;
  }
  
  .info-card dt:first-of-type {
    margin-top: 0;
  }
  
  .info-card dd {
    margin: 0.25rem 0 0 0;
    color: var(--text-secondary);
    line-height: 1.6;
  }
  
  .info-card code {
    background: var(--bg-secondary);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
  }
  
  .info-card a {
    color: var(--accent-primary);
  }
  
  @media (max-width: 640px) {
    .input-group {
      flex-direction: column;
    }
    
    .form-row {
      flex-direction: column;
    }
    
    .form-group.wide {
      min-width: 100%;
    }
  }
</style>

<script>
  import { 
    parseTraceParent, 
    encodeTraceParent, 
    parseTraceState, 
    generateSampleTraceParent,
    describeFlagsHuman
  } from '../lib/trace-context';
  import { generateTraceId, generateSpanId } from '../lib/id-generator';
  
  // DOM Elements - Decode
  const decodeInput = document.getElementById('decode-input') as HTMLInputElement;
  const decodeBtn = document.getElementById('decode-btn') as HTMLButtonElement;
  const sampleBtn = document.getElementById('sample-btn') as HTMLButtonElement;
  const decodeResults = document.getElementById('decode-results') as HTMLDivElement;
  
  // DOM Elements - Encode
  const encodeVersion = document.getElementById('encode-version') as HTMLInputElement;
  const encodeTraceId = document.getElementById('encode-trace-id') as HTMLInputElement;
  const encodeSpanId = document.getElementById('encode-span-id') as HTMLInputElement;
  const encodeSampled = document.getElementById('encode-sampled') as HTMLInputElement;
  const encodeBtn = document.getElementById('encode-btn') as HTMLButtonElement;
  const genTraceIdBtn = document.getElementById('gen-trace-id') as HTMLButtonElement;
  const genSpanIdBtn = document.getElementById('gen-span-id') as HTMLButtonElement;
  const encodeResults = document.getElementById('encode-results') as HTMLDivElement;
  
  // DOM Elements - Tracestate
  const tracestateInput = document.getElementById('tracestate-input') as HTMLInputElement;
  const tracestateBtn = document.getElementById('tracestate-btn') as HTMLButtonElement;
  const tracestateResults = document.getElementById('tracestate-results') as HTMLDivElement;
  
  // Decode functionality
  decodeBtn.onclick = () => decodeTraceparent();
  decodeInput.onkeydown = (e) => { if (e.key === 'Enter') decodeTraceparent(); };
  
  sampleBtn.onclick = () => {
    decodeInput.value = generateSampleTraceParent(true);
    decodeTraceparent();
  };
  
  function decodeTraceparent() {
    const value = decodeInput.value.trim();
    if (!value) {
      decodeResults.innerHTML = '';
      return;
    }
    
    const result = parseTraceParent(value);
    
    if (result.success && result.data) {
      const tp = result.data;
      decodeResults.innerHTML = `
        <div class="result-box success">
          <strong>Valid traceparent</strong>
          <div class="result-grid">
            <span class="result-label">Version:</span>
            <span class="result-value">${tp.version}</span>
            <span class="result-label">Trace ID:</span>
            <span class="result-value highlight">${tp.traceId}</span>
            <span class="result-label">Span ID:</span>
            <span class="result-value highlight">${tp.spanId}</span>
            <span class="result-label">Flags:</span>
            <span class="result-value">${describeFlagsHuman(tp.flags)} (0x${(tp.flags.sampled ? 1 : 0).toString(16).padStart(2, '0')})</span>
          </div>
        </div>
      `;
    } else {
      decodeResults.innerHTML = `
        <div class="result-box error">
          <strong>Invalid traceparent</strong>
          <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
            ${result.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
          </ul>
        </div>
      `;
    }
  }
  
  // Encode functionality
  genTraceIdBtn.onclick = () => {
    encodeTraceId.value = generateTraceId();
  };
  
  genSpanIdBtn.onclick = () => {
    encodeSpanId.value = generateSpanId();
  };
  
  encodeBtn.onclick = () => {
    const version = encodeVersion.value.trim() || '00';
    const traceId = encodeTraceId.value.trim();
    const spanId = encodeSpanId.value.trim();
    const sampled = encodeSampled.checked;
    
    const errors: string[] = [];
    
    if (!/^[0-9a-fA-F]{2}$/.test(version)) {
      errors.push('Version must be 2 hex characters');
    }
    if (!/^[0-9a-fA-F]{32}$/.test(traceId)) {
      errors.push('Trace ID must be 32 hex characters');
    }
    if (!/^[0-9a-fA-F]{16}$/.test(spanId)) {
      errors.push('Span ID must be 16 hex characters');
    }
    
    if (errors.length > 0) {
      encodeResults.innerHTML = `
        <div class="result-box error">
          <strong>Validation errors</strong>
          <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
            ${errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
          </ul>
        </div>
      `;
      return;
    }
    
    const header = encodeTraceParent({
      version: version.toLowerCase(),
      traceId: traceId.toLowerCase(),
      spanId: spanId.toLowerCase(),
      flags: { sampled }
    });
    
    encodeResults.innerHTML = `
      <div class="result-box success">
        <strong>Generated traceparent</strong>
        <div class="copy-row">
          <code>${header}</code>
          <button class="secondary-btn copy-btn" data-copy="${header}">Copy</button>
        </div>
      </div>
    `;
    
    attachCopyHandlers();
  };
  
  // Tracestate functionality
  tracestateBtn.onclick = () => parseTracestateHeader();
  tracestateInput.onkeydown = (e) => { if (e.key === 'Enter') parseTracestateHeader(); };
  
  function parseTracestateHeader() {
    const value = tracestateInput.value.trim();
    if (!value) {
      tracestateResults.innerHTML = '';
      return;
    }
    
    const result = parseTraceState(value);
    
    if (result.success && result.data) {
      if (result.data.entries.length === 0) {
        tracestateResults.innerHTML = `
          <div class="result-box">
            <strong>Empty tracestate</strong>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">No entries found</p>
          </div>
        `;
      } else {
        tracestateResults.innerHTML = `
          <div class="result-box success">
            <strong>Valid tracestate (${result.data.entries.length} entries)</strong>
            <table class="tracestate-table">
              <thead>
                <tr><th>Key</th><th>Value</th></tr>
              </thead>
              <tbody>
                ${result.data.entries.map(e => `<tr><td>${escapeHtml(e.key)}</td><td>${escapeHtml(e.value)}</td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    } else {
      tracestateResults.innerHTML = `
        <div class="result-box error">
          <strong>Invalid tracestate</strong>
          <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
            ${result.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
          </ul>
        </div>
      `;
    }
  }
  
  function attachCopyHandlers() {
    document.querySelectorAll('.copy-btn[data-copy]').forEach(btn => {
      (btn as HTMLButtonElement).onclick = async () => {
        const text = btn.getAttribute('data-copy');
        if (text) {
          await navigator.clipboard.writeText(text);
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
        }
      };
    });
  }
  
  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
</script>
